<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Tips</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #141a26; color: #b8c0cc; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
        h1 { text-align: center; font-size: 1.75rem; margin-bottom: 1.5rem; color: #d0d5de; font-weight: 600; }

        .round-selector { background: #1b2233; border-radius: 0.75rem; padding: 1.25rem 1.5rem; margin-bottom: 2rem; border: 1px solid #252e3f; }
        .round-selector-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: #6b7280; margin-bottom: 0.75rem; font-weight: 500; }
        .round-tabs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.4rem; }
        .round-tabs button {
            padding: 0.45rem 1rem; border: 1px solid #2a3347; background: transparent;
            color: #6b7280; border-radius: 0.375rem; cursor: pointer; font-size: 0.82rem; transition: all 0.2s; font-weight: 500;
        }
        .round-tabs button:hover { background: #232d40; color: #9ca3af; border-color: #3a4559; }
        .round-tabs button.active { background: #2a3a52; border-color: #3d5174; color: #94a8c7; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
        th { background: #1b2233; padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; }
        td { padding: 0.75rem 1rem; border-bottom: 1px solid #1e2738; }
        tr:hover td { background: #1b2233; }
        .rank { font-weight: 700; color: #d0d5de; width: 3rem; }
        .rank-1 { color: #c9a84c; }
        .rank-2 { color: #9ca3af; }
        .rank-3 { color: #a67c3d; }
        .score { font-weight: 600; font-variant-numeric: tabular-nums; }
        .change-up { color: #5b9e7a; }
        .change-down { color: #b06060; }
        .change-same { color: #4b5563; }

        .chart-container { background: #1b2233; border-radius: 0.75rem; padding: 1.5rem; border: 1px solid #252e3f; }
        h2 { font-size: 1.15rem; margin-bottom: 1rem; color: #d0d5de; font-weight: 600; }
        canvas { width: 100% !important; }

        .loading { text-align: center; padding: 2rem; color: #4b5563; }

        .standings-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; margin-bottom: 2rem; }
        .standings-panel { background: #1b2233; border-radius: 0.75rem; padding: 1rem; overflow-x: auto; border: 1px solid #252e3f; }
        .standings-panel h2 { font-size: 1rem; margin-bottom: 0.75rem; }
        .standings-panel table { margin-bottom: 0; font-size: 0.85rem; }
        .standings-panel th { background: #141a26; padding: 0.5rem 0.6rem; }
        .standings-panel td { padding: 0.5rem 0.6rem; }
        .match { color: #5b9e7a; }
        .no-match { color: #b06060; }
        .match-icon { font-weight: 700; margin-right: 0.3rem; }
        @media (max-width: 768px) { .standings-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Football Tips</h1>
        <div class="round-selector">
            <div class="round-selector-label">Select Round</div>
            <div class="round-tabs" id="roundTabs"></div>
        </div>
        <table id="scoreTable">
            <thead>
                <tr><th>Rank</th><th>Player</th><th>Round Score</th><th>Change</th></tr>
            </thead>
            <tbody id="scoreBody">
                <tr><td colspan="4" class="loading">Loading...</td></tr>
            </tbody>
        </table>
        <div class="standings-grid">
            <div class="standings-panel">
                <h2 id="predictedTitle">Best Prediction</h2>
                <table>
                    <thead><tr><th>#</th><th>Team</th><th>Off</th></tr></thead>
                    <tbody id="predictedBody">
                        <tr><td colspan="2" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="standings-panel">
                <h2>Actual Standings</h2>
                <table>
                    <thead><tr><th>#</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead>
                    <tbody id="actualBody">
                        <tr><td colspan="8" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="chart-container">
            <h2>Rankings Per Round</h2>
            <canvas id="chart" height="300"></canvas>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    <script>
        const COLORS = ['#5a7da8','#b09558','#5b9e7a','#b06060','#7e6fa8','#a66b8a','#4d9690','#b07850'];
        const cap = s => s.charAt(0).toUpperCase() + s.slice(1);
        let chart = null;
        let currentRound = null;

        async function loadRounds() {
            const res = await fetch('/api/rounds');
            const rounds = await res.json();
            const tabs = document.getElementById('roundTabs');
            rounds.forEach(r => {
                const btn = document.createElement('button');
                btn.textContent = r.round_name;
                btn.dataset.id = r.round_id;
                btn.onclick = () => selectRound(r.round_id);
                tabs.appendChild(btn);
            });
            if (rounds.length) selectRound(rounds[rounds.length - 1].round_id);
        }

        async function selectRound(roundId) {
            currentRound = roundId;
            document.querySelectorAll('.round-tabs button').forEach(b =>
                b.classList.toggle('active', parseInt(b.dataset.id) === roundId));
            const res = await fetch(`/api/scores/${roundId}`);
            const scores = await res.json();
            const body = document.getElementById('scoreBody');
            body.innerHTML = scores.map(s => {
                const cls = s.rank <= 3 ? ` rank-${s.rank}` : '';
                let changeCls = 'change-same';
                if (s.rank_change.includes('\u2191')) changeCls = 'change-up';
                else if (s.rank_change.includes('\u2193')) changeCls = 'change-down';
                return `<tr>
                    <td class="rank${cls}">${s.rank}</td>
                    <td>${cap(s.team_name)}</td>
                    <td class="score">${s.cumulative_score.toLocaleString()}</td>
                    <td class="${changeCls}">${s.rank_change}</td>
                </tr>`;
            }).join('');
            loadStandings(roundId);
        }

        async function loadStandings(roundId) {
            const res = await fetch(`/api/standings/${roundId}`);
            const data = await res.json();
            const actualMap = {};
            data.actual.forEach(r => { actualMap[r.team] = r.position; });
            document.getElementById('predictedTitle').textContent =
                `Best Prediction (${cap(data.best_user)})`;
            document.getElementById('predictedBody').innerHTML = data.predicted.map(r => {
                const actualPos = actualMap[r.team];
                const diff = Math.abs(actualPos - r.position);
                const cls = diff === 0 ? 'match' : 'no-match';
                return `<tr>
                    <td class="rank">${r.position}</td>
                    <td class="${cls}">${r.team}</td>
                    <td class="${cls}">${diff === 0 ? '\u2713' : diff}</td>
                </tr>`;
            }).join('');
            document.getElementById('actualBody').innerHTML = data.actual.map(r => {
                return `<tr>
                    <td class="rank">${r.position}</td>
                    <td>${r.team}</td>
                    <td>${r.played}</td>
                    <td>${r.w}</td>
                    <td>${r.d}</td>
                    <td>${r.l}</td>
                    <td>${r.gd}</td>
                    <td>${r.pts}</td>
                </tr>`;
            }).join('');
        }

        async function loadChart() {
            const res = await fetch('/api/cumulative-data');
            const data = await res.json();
            const ctx = document.getElementById('chart').getContext('2d');
            const teams = Object.keys(data.teams);
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.rounds,
                    datasets: teams.map((name, i) => ({
                        label: cap(name),
                        data: data.teams[name],
                        borderColor: COLORS[i % COLORS.length],
                        backgroundColor: COLORS[i % COLORS.length] + '22',
                        tension: 0.3,
                        pointRadius: 4,
                        borderWidth: 2
                    }))
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' },
                            onClick: (e, legendItem, legend) => {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                const isHighlighted = ci.data.datasets[index].borderWidth === 4;
                                ci.data.datasets.forEach((ds, i) => {
                                    if (isHighlighted) {
                                        ds.borderWidth = 2;
                                        ds.borderColor = COLORS[i % COLORS.length];
                                        ds.pointRadius = 4;
                                    } else {
                                        if (i === index) {
                                            ds.borderWidth = 4;
                                            ds.pointRadius = 6;
                                        } else {
                                            ds.borderWidth = 1;
                                            ds.borderColor = COLORS[i % COLORS.length] + '33';
                                            ds.pointRadius = 2;
                                        }
                                    }
                                });
                                ci.update();
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
                        y: { reverse: true, ticks: { color: '#64748b', stepSize: 1 }, grid: { color: '#1e293b' } }
                    }
                }
            });
        }

        loadRounds();
        loadChart();
    </script>
</body>
</html>
